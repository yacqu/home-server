const seApp = Application('System Events')
const messagesApp = Application('Messages')
messagesApp.includeStandardAdditions = true;

// Run and get passed in arguments
ObjC.import('stdlib')                               // for exit

var args = $.NSProcessInfo.processInfo.arguments    
var argv = []
var argc = args.count
for (var i = 4; i < argc; i++) {
    // skip 3-word run command at top and this file's name
    argv.push(ObjC.unwrap(args.objectAtIndex(i)))  
}

const number = argv[0]
const message = argv[1]

sendNewMessage(number, message)

function sendNewMessage(number, message) {
    //messagesApp.quit()
    delay(3)
    messagesApp.activate()

    // Adjust delay as necessary
    delay(1)
    
    seApp.keystroke('n', {using: 'command down'})
    delay(2)
    seApp.keystroke(number)
    delay(2)
    seApp.keyCode(76) //enter
    delay(2)    
    seApp.keyCode(48) //tab
    delay(1)
    seApp.keystroke(message)
    delay(1)
    seApp.keyCode(76)

    return getHandleForNumber(number)
}

function getHandleForNumber(number) {
    // Return handle id associated with number
    return messagesApp.buddies.whose({handle:{_contains: number}})[0].id()
}


// Should prevent app from quitting
function quit() {
    return true;
}

seApp.keyUp(59)
$.exit(0)